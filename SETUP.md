# Insight - Setup Instructions

## Prerequisites

1. **Python 3.11+** installed
2. **Docker Desktop** installed and running (for PostgreSQL)
3. **Anthropic API Key** from [console.anthropic.com](https://console.anthropic.com)

## Installation Steps

### 1. Create and Activate Virtual Environment

```bash
# Create virtual environment
python -m venv venv

# Activate (Windows)
venv\Scripts\activate

# Activate (macOS/Linux)
source venv/bin/activate
```

### 2. Install Dependencies

```bash
pip install -r requirements/base.txt
```

For development with debug tools:
```bash
pip install -r requirements/dev.txt
```

### 3. Configure Environment Variables

The `.env` file has been created. **You MUST update it with your Anthropic API key:**

1. Open `.env` in a text editor
2. Replace `sk-ant-api03-your-key-here` with your actual Anthropic API key
3. Optionally generate a new SECRET_KEY:
   ```bash
   python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
   ```

### 4. Start PostgreSQL Database

```bash
docker-compose up -d
```

Verify it's running:
```bash
docker-compose ps
```

### 5. Run Database Migrations

```bash
python manage.py makemigrations
python manage.py migrate
```

### 6. Create Superuser

```bash
python manage.py createsuperuser
```

Follow the prompts to create an admin account.

### 7. Create Media Directory

```bash
mkdir media
```

### 8. Run Development Server

```bash
python manage.py runserver
```

The application will be available at [http://localhost:8000](http://localhost:8000)

## First Use

1. **Login** at [http://localhost:8000/accounts/login/](http://localhost:8000/accounts/login/)
2. **Upload a dataset** (CSV or Excel file, max 100MB)
3. **Ask questions** about your data in natural language
4. **View visualizations** generated by PandasAI + Anthropic

## Project Structure

```
Insight/
├── core/                   # Main application
│   ├── models.py          # Dataset, AnalysisSession, QueryLog (Fat Models)
│   ├── views.py           # Thin views (orchestration only)
│   ├── forms.py           # DatasetUploadForm, QueryForm
│   ├── utils.py           # LLM client, DataFrame caching
│   ├── managers.py        # QueryLogManager
│   └── templates/         # HTML templates
├── Insight/               # Django project settings
├── requirements/          # Python dependencies
├── docker-compose.yml     # PostgreSQL container
├── .env                   # Environment variables (DO NOT COMMIT)
└── manage.py              # Django management script
```

## Common Commands

```bash
# Start database
docker-compose up -d

# Stop database
docker-compose down

# Run migrations
python manage.py makemigrations
python manage.py migrate

# Create superuser
python manage.py createsuperuser

# Run development server
python manage.py runserver

# Access Django admin
# http://localhost:8000/admin/

# Collect static files (for production)
python manage.py collectstatic
```

## Troubleshooting

### Database Connection Error

Ensure Docker is running and PostgreSQL container is up:
```bash
docker-compose ps
```

### Anthropic API Error

Verify your API key in `.env` is correct and has sufficient credits.

### File Upload Error

Check that the `media/` directory exists and is writable:
```bash
mkdir -p media
```

### Import Error (python-magic)

On Windows, ensure `python-magic-bin` is installed:
```bash
pip install python-magic-bin
```

## Architecture Notes

- **Fat Models Pattern**: Business logic in `models.py` (e.g., `execute_query()`, `ingest_and_validate()`)
- **Thin Views**: Views only handle validation, authorization, and delegation
- **HTMX**: No page reloads during chat interactions
- **PostgreSQL**: Production-ready database via Docker
- **PandasAI + Anthropic**: Claude Sonnet 4.5 powers natural language queries

## Security

- ✅ File validation uses content-type (magic bytes), not just extensions
- ✅ Macro-enabled Excel files (.xlsm) are blocked
- ✅ User authorization on all dataset/session access
- ✅ 100MB file upload limit
- ✅ Environment variables in `.env` (not committed to git)
- ✅ CSRF protection on all forms

## Next Steps

1. **Test with sample data**: Upload a CSV/Excel file
2. **Try queries**: "Show first 5 rows", "Plot sales by region", "What's the average revenue?"
3. **Check context**: Ask follow-up questions that reference previous responses
4. **View in admin**: [http://localhost:8000/admin/](http://localhost:8000/admin/)

## Support

For issues, check:
- Django error logs in console
- Docker logs: `docker-compose logs`
- File permissions on `media/` directory
- Anthropic API status: [status.anthropic.com](https://status.anthropic.com)
